# 第1章 单行Perl简介

130个解决问题的程序



单行Perl是小巧的Perl程序，一般是单行代码。它擅长解决的问题包括更改行距，对行编号，执行计算，转换和替换文本，删除和打印特定行，解析日志，就地编辑文件，计算统计信息，执行系统管理任务或一次更新一堆文件。单行Perl将使您成为一个空壳战士：以前需要几分钟（甚至几小时）解决的问题，现在只需要几秒钟！

在本介绍性章节中，我将向您展示单行Perl是什么，并带您领略本书其余部分的内容。本书需要一些Perl知识，但是大多数单行代码可以在不深入了解该语言的情况下进行调整和修改。

让我们看一些例子。比如：

```perl
perl -pi -e 's/you/me/g' file
```

这行代码实现的功能是将file文件文本中所有的*you*替换成*me*。假设您在远程服务器上，并且需要替换文件中的文本。您可以在文本编辑器中打开文件并执行查找-替换，也可以仅通过命令行执行替换，然后Bam一下子就完成该操作。

该单行代码和本书中的其他代码在**UNIX**系统上运行良好。我正在使用Perl 5.8来运行它们，但是它们也可以在更新的Perl版本中使用，例如Perl 5.10和更高版本。如果您使用的是Windows计算机，则需要对其进行一些更改。 要使此单行代码在Windows上工作，请将单引号替换为双引号。要了解有关在Windows上使用Perl单行代码的更多信息，请参阅附录B。

在整本书中，我将使用Perl的**-e**命令行参数。 它允许您使用命令行指定要执行的Perl代码。在前面的单行代码中，代码显示为“执行替换（*s/you/me/g*命令），然后全局将*you*替换为*me*（*/g*标志）。” **-p**参数确保在输入的每一行上执行代码，并确保在执行后打印该行。**-i**参数确保文件被就地编辑。就地编辑意味着Perl直接在文件中执行所有替换，从而覆盖要替换的内容。我建议您始终通过为**-i**参数指定备份扩展名来备份正在使用的文件，如下所示：

```perl
perl -pi.bak -e 's/you/me/g' file
```

现在，Perl首先创建一个*file.bak*备份文件，然后才更改*file*文件的内容。

如何在多个文件中执行相同的替换？ 只需在命令行上指定文件：

```perl
perl -pi -e 's/you/me/g' file1 file2 file3
```

在这里，Perl首先在*file1*中将*you*替换为*me*，然后在file2和file3中执行相同的操作。

您也可以只在匹配*we*的行上执行相同的替换，就像这样：

```perl
perl -pi -e 's/you/me/g if /we/' file
```

在这里，使用条件*if /we/*来确保*s /you/me/g*仅在与正则表达式*/we/*匹配的行上执行。

正则表达式可以是任何东西。 假设您只想对包含数字的行执行替换。 您可以使用/\d/正则表达式来匹配数字：

```perl
perl -pi -e 's/you/me/g if /\d/' file
```

如何查找文件中出现多次的行？

```perl
perl -ne 'print if $a{$_}++' file
```

这行代码可将您到目前为止看到的行记录在*％a*哈希中，并计算它看到这些行的次数。如果已经看过该行，则条件*$a{$_}++*为真，因此它将打印该行。否则，它将“自动”创建一个元素，当前行保存在在*％a*哈希中，并增加其值。特殊变量*$_*包含当前行。这个单行代码还使用*-n*命令行参数来循环输入，但是与*-p*不同，它不会自动打印行。

如何对行进行编号？ 超级简单! Perl的*$.* 特殊变量保持当前行号。 只需将其与行一起打印即可：

```perl
perl -ne 'print "$. $_"' file
```

您可以通过使用*-p*参数并修改*$_*变量来执行相同的操作：

```perl
perl -pe '$_ = "$. $_"' file
```



如果在单行结尾处省略文件名，则Perl将从标准输入中读取数据。 从现在开始，我将假定数据来自标准输入，并将文件名放在最后。 如果要在整个文件上运行单行，则可以随时将其放回去。

您还可以结合前两个单行perl创建仅对重复行编号的代码：

```perl
perl -ne 'print "$. $_" if $a{$_}++'
```

您可以做的另一件事是使用**List :: Util** CPAN模块中的sum函数对每一行中的数字求和。CPAN (Comprehensive Perl Archive Network; *http://www.cpan.org/*)是超过100,000个可重复使用的Perl模块的档案。**List :: Util**是CPAN上的模块之一，它包含各种list实用程序功能。您不需要安装此模块，因为它是Perl随附的（它在Perl内核中）。

```perl
perl -MList::Util=sum -alne 'print sum @F'
```

**-MList :: Util**命令行参数导入**List :: Util**模块。代码的*=sum*从**List::Util**模块导入*sum*函数，以便程序可以使用该函数。接下来，**-a**参数自动将当前行拆分为**@F**数组中的字段。默认情况下，以空白字符作为拆分分隔符。**-l**参数确保**print**在每行末尾输出换行符。最后，**sum @F**对**@F**列表中的所有元素求和，然后**print**打印结果，后跟换行符。

如何查找1299天前的日期？ 试试这个：

```perl
perl -MPOSIX -le '@t = localtime; $t[3] -=1299; print scalar localtime mktime @t'
```

我将在代码**4.19**中详细解释此示例。大致的思路是，需要修改localtime返回的结果的第四个元素，即表示哪一天。您只需从当天减去1299天，然后使用**localtime mktime @t**将结果重新组合为新时间，然后在标量上下文中打印结果以显示人类可读的时间。

如何生成一个八个字母的密码？ 试一下这个：

```perl
perl -le 'print map{("a".."z")[rand 26]}1..8'
```

“ a” ..“ z”生成从a到z的字母列表（总共26个字母）。 然后，您随机选择一个字母八次！

或者假设您要查找与IP地址相对应的十进制数字。 您可以使用unpack快速找到它：

```perl
perl -le 'print unpack("N",127.0.0.1)'
```

这行代码使用*v-string*，这是文字版本。 V字符串提供了一种使用指定序数组成字符串的方法。IP地址127.0.0.1被视为v字符串，这意味着将数字127、0、0、1串联成一个包含四个字符的字符串，其中第一个字符的序号为127，第二个和第三个字符 序号为0，最后一个字符的序号为1。接下来，解包将它们按“网络”（大端顺序）顺序解压缩为单个十进制数。

那么怎么计算呢？ 让我们在表格的第一列中找到数字的总和：

```perl
perl -lane '$sum +=$F[0]; END{print $sum}'
```

代码使用**-a**参数自动拆分为字段，可以通过**@F**数组进行访问。 数组的第一个元素**$F[0]**是第一列，因此您只需将所有列相加即可。Perl程序完成后，它将执行END块中的任何代码，在上面这种情况下，它将打印总和。

现在，让我们找出通过iptables规则传递了多少个数据包：

```perl
iptables -L -nvx | perl -lane '$pkts += $F[0];END{print $pkts}'
```

iptables程序在第一列中输出数据包。 要找出已通过防火墙规则的数据包数量，您要做的就是对第一栏中的数字求和。 尽管iptables也将输出表头，但是您可以放心地忽略它们，因为Perl在+ =操作中将它们转换为零。

如何获取系统上所有用户的列表？

```perl
perl -a -F: -lne 'print $F[4]' /etc/passwd
```

将**-a**与**-F**参数结合使用，可以指定应该在其中分割行的字符，默认情况下，该字符为空白。 在这里，使用冒号字符（/etc/passwd的记录分隔符）上分割行。 接下来，打印第五个字段$F[4]，其中包含用户的真实姓名。

如果忘记了命令行参数，请记住Perl附带了一个很棒的文档系统**perldoc**。 在命令行中输入**perldoc perlrun**。 这将显示有关如何运行Perl和所有命令行参数的文档。 当您突然忘记哪个命令行参数可以做什么并且需要快速查找时，这很有用。您可能还想阅读**perldoc perlvar**，它解释了变量。 **perldoc perlop**，它解释了运算符； 和**perldoc perlfunc**，它解释了函数。

单行Perl可让您快速完成许多任务。 您会在本书中找到130多个单行Perl程序。 阅读它们，尝试一下，很快，您将成为本地的shell向导。